<template>
    <div class="flex-center flex-column full-height-vh" :class="{ body_warning: wrongCode, body_success: success }">
        
        
        <div class="title">
            <!-- {{ title }} -->
            –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∑–∞–≥–ª—è–Ω—É–ª–∏ –∫ –Ω–∞–º –Ω–∞ <span @click="click++">–ë–∞–Ω–∞–Ω—ã—á!</span> 
        </div>

        <div v-if="click < 5" style="max-width:540px">

            <div class="text-center sub-text trans">
                –ë–∞–Ω–∞–Ω—ã—á —É—à—ë–ª –Ω–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. –ë—É–¥–µ—Ç —É–ª—É—á—à–∞—Ç—å—Å—è –¥–ª—è –≤–∞—Å –∏ —Å–∫–æ—Ä–æ —Å—Ç–∞–Ω–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —É–¥–æ–±–Ω—ã–º —Å–∞–π—Ç–æ–º <span @click="click++">üôÇ</span>   –º—ã –æ—á–µ–Ω—å —Å—Ç–∞—Ä–∞–µ–º—Å—è –¥–æ–¥–µ–ª–∞—Ç—å –≤—Å–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–µ–º –≤–∞–º, –∫–æ–≥–¥–∞ –±—É–¥–µ–º –≥–æ—Ç–æ–≤—ã –æ–ø—è—Ç—å –≤–∞—Å —Ä–∞–¥–æ–≤–∞—Ç—å! 
                <br><br>
                <!-- –í—Å–µ –±–æ–Ω—É—Å—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –∏ –∑–∞ –≤—Ä–µ–º—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ —Å–≥–æ—Ä—è—Ç. –ï—Å–ª–∏ –º—ã –≤–∞–º  –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ —Å–≤–æ–∏ "–∫–æ—Å—è–∫–∏" –±–æ–Ω—É—Å–∞–º–∏ –∏ –≤—ã –Ω–µ —É—Å–ø–µ–ª–∏ –∏—Ö –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –≤ —Å–æ—Ü —Å–µ—Ç—è—Ö –∏ –º—ã –≤–µ—Ä–Ω—ë–º –∏—Ö –≤–∞–º –¥–µ–Ω—å–≥–∞–º–∏. -->
                <!-- <br><br> -->
                –î–æ —Å–∫–æ—Ä—ã—Ö –≤—Å—Ç—Ä–µ—á!                    
            </div>

            <!-- <p class="text-center contact trans" style="margin-top: 40px;font-size: 8pt;">
			    –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å –ê—Å–ª–∞–Ω–æ–≤–∞ –î–∞—Ä—å—è –î–º–∏—Ç—Ä–∏–µ–≤–Ω–∞ <br> –ò–ù–ù 781423763823 –û–ì–†–ù–ò–ü 319784700217743 <br> 197183 –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –°–µ—Ä–µ–±—Ä—è–∫–æ–≤ –ø–µ—Ä. 5/36 - 4 <br> +79219444137  <a href="mailto:">  </a>
            </p> -->

        </div>

        <div v-if="attempts_left !== false">
            <p>{{ attempts_left }}</p>
        </div>

        <div v-if="seconds_message !== false">
            <p>{{ seconds_message }}</p>
        </div>

        <div v-if="click >= 5" class="panel flex flex-column relative" :class="{ wrong_code: wrongCode, success_code: success }">
            <loader v-if="showLoader & isLoading"></loader>

            <div class="flex-one">
                <div class="flex full-height">
                    <div class="flex-one number" v-for="number in totalDigits">
                        <div class="flex-center full-height">
                            <h3>{{ code[number - 1] }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-three">
                <div class="flex flex-column full-height">
                    <div class="flex-one" v-for="row in 3">
                        <div class="flex full-height">
                            <div class="flex-one number" v-for="number in 3" @click="addNumber(getNumber(row, number))">
                                <div class="flex-center full-height">
                                    <h3>{{ getNumber(row, number) }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-one">
                        <div class="flex full-height">

                            <div class="flex-one number" @click="togglePassword">
                                <div class="flex-center full-height">
                                    <h3>{{ toggle_password_text }}</h3>
                                </div>
                            </div>

                            <div class="flex-one number" @click="addNumber(0)">
                                <div class="flex-center full-height">
                                    <h3>0</h3>
                                </div>
                            </div>

                            <div class="flex-two number" @click="back()">
                                <div class="flex-center full-height">
                                    <h3>{{ backButton }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import Loader from './uc-Loader';

    export default {
        components: { Loader },

        props: [
            'title',
            'backButton',
            'showButton',
            'hideButton',
            'showLoader',
            'totalDigits',
            'redirectUrl',
        ],

        data() {
            return {
                click:0,
                code: [],
                real_code: [],
                hide_code: true,
                position: 0,
                wrongCode: false,
                success: false,
                seconds_message: false,
                attempts_left: false,
                seconds: 0,
                isLoading: false
            }
        },

        computed: {
            toggle_password_text: function() {
                return this.hide_code ? this.showButton : this.hideButton;
            }
        },

        mounted() {
            this.registerKeys();
            this.resetCode();
            this.checkIfLimited();
        },

        methods: {

            /**
             * Calculate the number
             */
            getNumber(row, number) {
                return number + (3 - row) * 3;
            },

            /**
             * Add entered number to code array.
             */
            addNumber(number) {
                if(!this.seconds_message) {
                    this.setNumber(number);
                    if(this.codeIsComplete()) {
                        this.isLoading = true;
                        axios.post("check", { "code": this.real_code.join("") })
                            .then(() => {
                                this.success = true;
                                window.location.href = this.redirectUrl;
                            })
                            .catch((error) => {
                                this.wrongCode = true;
                                setTimeout(() => this.wrongCode = false, 5000);
                                if(this.tooManyAttempts(error)) {
                                    this.countDown(error.response.data.seconds_message);
                                }
                                else {
                                    this.attempts_left = error.response.data.attempts_left;
                                }
                                this.resetCode();
                            })
                            .finally(() => {
                                this.isLoading = false;
                            });
                    }
                }
            },

            /**
             * Extract the seconds out of the string. Then
             * start a timer and decrement it every second.
             */
            countDown(message) {
                this.attempts_left = false;
                this.seconds_message = message;
                let timer = setInterval(() => {
                    if(this.seconds == 1) {
                        this.seconds_message = false;
                        this.seconds = 0;
                        clearInterval(timer);
                    }
                    else {
                        this.seconds_message = this.seconds_message.replace(/\d+/g, (match) => {
                            this.seconds = parseInt(match) - 1;
                            return this.seconds;
                        });
                    }
                }, 1000);
            },

            tooManyAttempts(error) {
                return error.response.data.too_many_attempts;
            },

            back() {
                if(this.position > 0) {
                    Vue.set(this.code, this.position -1, "*");
                    this.position--;
                }
            },

            resetCode() {
                this.setAmountOfDigits();
                this.position = 0;
            },

            setAmountOfDigits() {
                this.code = [];

                for ( let i = 0; i < this.totalDigits; i++ ) {
                    this.code.push("*")
                }
            },

            /**
             * Set number at the correct array position.
             */
            setNumber(number) {
                Vue.set(this.real_code, this.position, number);

                if ( this.hide_code ) {
                    Vue.set(this.code, this.position, '-' );
                } else {
                    Vue.set(this.code, this.position, number);
                }
                this.position++;
            },

            /**
             * Check if all numbers are entered.
             */
            codeIsComplete() {
                return this.position === this.totalDigits;
            },

            /**
             * Register all keyboard numbers.
             */
            registerKeys() {
                document.addEventListener("keydown", (e) => {
                    e.preventDefault();
                    let key = e.which || e.charCode || e.keyCode || 0;

                    if (key == 8) {
                        this.back();

                        return;
                    }

                    //for numpad
                    if(key >= 96 && key <= 105) {
                        key -= 48;
                    }

                    let number = parseInt(String.fromCharCode(key));

                    if (isNaN(number)) {
                        return;
                    }

                    if(!this.isLoading) {
                        this.addNumber(number);
                    }
                });
            },

            /**
             * Toggles password display mode
             */
            togglePassword() {
                this.hide_code = !this.hide_code;

                this.setAmountOfDigits();

                for ( let i = 0; i < this.position; i++ ) {
                    if ( this.hide_code ) {
                        Vue.set(this.code, i, '-' );
                    } else {
                        Vue.set(this.code, i, this.real_code[i]);
                    }
                }

            },

            /**
             * Run at start to check whether user been limited from server
             */
            checkIfLimited() {
                this.isLoading = true;
                axios.post("checkiflimited")
                    .catch((error) => {
                        this.wrongCode = true;
                        setTimeout(() => this.wrongCode = false, 5000);
                        if(this.tooManyAttempts(error)) {
                            this.countDown(error.response.data.seconds_message);
                        }
                        else {
                            this.attempts_left = error.response.data.attempts_left;
                        }
                    })
                    .finally(() => {
                        this.isLoading = false;
                    });
            }
        }
    }
</script>

<style scoped>

    .flex-center.flex-column.full-height-vh{
        background-color:#bdbdbd;
    }

    .title {
        font-size: 40px !important;
    }

</style>

<style lang="sass" scoped>

    $success: #27ae60
    $warning: #e74c3c
    $box-shadow: 0 2px 3px 0
    $shadow-color: rgba(0,0,0,.16)
    $mobile-break-point: 750px

    .wrong_code
        box-shadow: $box-shadow $warning

    .success_code
        box-shadow: $box-shadow $success

    .body_warning
        color: $warning

    .body_success
        color: $success

    .flex
        display: flex

        &-one
            flex: 1

        &-two
            flex: 1

        &-three
            flex: 3

        &-center
            @extend .flex
            align-items: center
            justify-content: center

        &-column
            flex-direction: column

    .full-height
        height: 100%

        &-vh
            height: 100vh

    .panel
        width: 300px
        height: 400px
        background: #F8F8FA
        box-shadow: $box-shadow $shadow-color
        border-radius: 6px

    .number
        margin: 10px
        border-bottom: 1px solid #DCDCDE
        cursor: pointer
        div
            -webkit-user-select: none
            -moz-user-select: none
            -ms-user-select: none
            user-select: none
            h3
                font-size: 15px
                font-weight: 900

        &:hover
            box-shadow: $box-shadow $shadow-color

    .title
        font-size: 84px
        margin-bottom: 40px

    .relative
        position: relative

    @media only screen and (max-width: $mobile-break-point)
        .title
            display: none




</style>
